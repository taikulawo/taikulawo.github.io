<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.chaochaogege.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="工作中涉及Nginx module开发，分析Nginx&#x2F;tengine代码 nginx modules初始化 每个 module 必须有 ngx_module_t，且在module不同生命周期都支持 hook 函数 123456789101112131415161718192021222324252627282930313233343536struct ngx_module_s &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 代码分析">
<meta property="og:url" content="http://www.chaochaogege.com/2022/08/18/59/index.html">
<meta property="og:site_name" content="稳中向好">
<meta property="og:description" content="工作中涉及Nginx module开发，分析Nginx&#x2F;tengine代码 nginx modules初始化 每个 module 必须有 ngx_module_t，且在module不同生命周期都支持 hook 函数 123456789101112131415161718192021222324252627282930313233343536struct ngx_module_s &amp;#123;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://user-images.githubusercontent.com/24750337/186622825-8cc33160-bc89-4dc0-98ff-6307df27d683.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/24750337/188052512-c07e011e-760d-42bb-9e3e-194c90f1e3e1.png">
<meta property="article:published_time" content="2022-08-18T00:00:00.000Z">
<meta property="article:modified_time" content="2024-04-23T00:00:00.000Z">
<meta property="article:author" content="超超哥哥">
<meta property="article:tag" content="基础">
<meta property="article:tag" content="net">
<meta property="article:tag" content="C&#x2F;C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/24750337/186622825-8cc33160-bc89-4dc0-98ff-6307df27d683.png">

<link rel="canonical" href="http://www.chaochaogege.com/2022/08/18/59/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nginx 代码分析 | 稳中向好</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">稳中向好</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.chaochaogege.com/2022/08/18/59/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/favicon.ico">
      <meta itemprop="name" content="超超哥哥">
      <meta itemprop="description" content="好奇心">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="稳中向好">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx 代码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-18 00:00:00" itemprop="dateCreated datePublished" datetime="2022-08-18T00:00:00+00:00">2022-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-23 00:00:00" itemprop="dateModified" datetime="2024-04-23T00:00:00+00:00">2024-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>工作中涉及Nginx module开发，分析Nginx/tengine代码</p>
<h2 id="nginx-modules初始化">nginx modules初始化</h2>
<p>每个 module 必须有 ngx_module_t，且在module不同生命周期都支持 hook 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_module_s</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>            ctx_index;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            index;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>                 *name;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>            spare0;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            spare1;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>            version;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>           *signature;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                 *ctx;</span><br><span class="line">    <span class="type">ngx_command_t</span>        *commands;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            type;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_int_t</span>           (*init_master)(<span class="type">ngx_log_t</span> *<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_int_t</span>           (*init_module)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_int_t</span>           (*init_process)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="type">ngx_int_t</span>           (*init_thread)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="type">void</span>                (*exit_thread)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line">    <span class="type">void</span>                (*exit_process)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                (*exit_master)(<span class="type">ngx_cycle_t</span> *cycle);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook0;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook1;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook2;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook3;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook4;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook5;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook6;</span><br><span class="line">    <span class="type">uintptr_t</span>             spare_hook7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>由于 ngx_module_t 为基础类型，对于http和stream，通过 ngx_module_t#ctx进行了扩展，用于放置 http/stream module相关的 hook 函数</p>
<p>比如http module中，ctx 为 ngx_http_module_t 类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_int_t</span>   (*preconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">ngx_int_t</span>   (*postconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>       *(*create_main_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>       *(*init_main_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *conf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>       *(*create_srv_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>       *(*merge_srv_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev, <span class="type">void</span> *conf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>       *(*create_loc_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>       *(*merge_loc_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev, <span class="type">void</span> *conf);</span><br><span class="line">&#125; <span class="type">ngx_http_module_t</span>;</span><br></pre></td></tr></table></figure>
<p>stream module 对 module ctx 扩展</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_int_t</span>                    (*preconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">ngx_int_t</span>                    (*postconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                        *(*create_main_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>                        *(*init_main_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *conf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                        *(*create_srv_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>                        *(*merge_srv_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev,</span><br><span class="line">                                                   <span class="type">void</span> *conf);</span><br><span class="line">&#125; <span class="type">ngx_stream_module_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>nginx cycle 是最上层的大类，存放全部nginx运行上下文，其中<br>
cycle-&gt;modules 存放全部的module，包含http_core modules，第三方http modules, event modules 等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_cycle_modules</span><span class="params">(<span class="type">ngx_cycle_t</span> *cycle)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * create a list of modules to be used for this cycle,</span></span><br><span class="line"><span class="comment">     * copy static modules to it</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    cycle-&gt;modules = ngx_pcalloc(cycle-&gt;pool, (ngx_max_module + <span class="number">1</span>)</span><br><span class="line">                                              * <span class="keyword">sizeof</span>(<span class="type">ngx_module_t</span> *));</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;modules == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将全部的modules都放到cycle-&gt;modules中</span></span><br><span class="line">    <span class="comment">// ngx_modules 是编译后自动生成的文件，里面引用了全部modules</span></span><br><span class="line">    ngx_memcpy(cycle-&gt;modules, ngx_modules,</span><br><span class="line">               ngx_modules_n * <span class="keyword">sizeof</span>(<span class="type">ngx_module_t</span> *));</span><br><span class="line"></span><br><span class="line">    cycle-&gt;modules_n = ngx_modules_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="各个hook的调用时机">各个hook的调用时机</h3>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dev/development_guide.html#core_modules">http://nginx.org/en/docs/dev/development_guide.html#core_modules</a></p>
<h4 id="init-module">init_module</h4>
<p>master 进程在每次配置初始化之后调用</p>
<h4 id="init-process">init_process</h4>
<p>master进程创建完worker后，worker中调用。所以init_process在worker的上下文中</p>
<h4 id="exit-process">exit_process</h4>
<p>worker 退出时调用</p>
<h4 id="exit-master">exit_master</h4>
<p>master退出时调用</p>
<h2 id="module自身配置的创建与解析module指令command">module自身配置的创建与解析module指令command</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/core/ngx_cycle.c#L238</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历全部的模块</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cycle-&gt;modules[i]-&gt;type != NGX_CORE_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module = cycle-&gt;modules[i]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;create_conf) &#123;</span><br><span class="line">        <span class="comment">// init_cycle 阶段调用 module#create_conf 创建每个module初始状态的配置文件</span></span><br><span class="line">        rv = module-&gt;create_conf(cycle);</span><br><span class="line">        <span class="keyword">if</span> (rv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ngx_destroy_pool(pool);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// cycle 下</span></span><br><span class="line">        cycle-&gt;conf_ctx[cycle-&gt;modules[i]-&gt;index] = rv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>我发现 nginx 遍历全部modules的代码挺多的，为了实现某个功能，经常要遍历全部modules</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/core/ngx_conf_file.c#L447</span></span><br><span class="line"><span class="comment">// 在create_conf 已经创建好了 module conf，并存放到了 cf-&gt;ctx数组，下标是module的index</span></span><br><span class="line"><span class="comment">// 由于这是配置文件解析阶段，需要初始化每个module 的配置，所以调用module#ngx_command_t#set 方法，交由module处理每个directive（command）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[i]; i++) &#123;</span><br><span class="line">    <span class="comment">// 遍历全部 modules</span></span><br><span class="line"></span><br><span class="line">    cmd = cf-&gt;cycle-&gt;modules[i]-&gt;commands;</span><br><span class="line">    <span class="keyword">if</span> (cmd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( <span class="comment">/* void */</span> ; cmd-&gt;name.len; cmd++) &#123;</span><br><span class="line">        <span class="comment">// 处理每个module的ngx_command_t[]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name-&gt;len != cmd-&gt;name.len) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 寻找name相同的command</span></span><br><span class="line">        <span class="comment">// 比如 http block 的command#name是 http</span></span><br><span class="line">        <span class="comment">// static ngx_command_t  ngx_http_commands[] = &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     &#123; ngx_string(&quot;http&quot;),</span></span><br><span class="line">        <span class="comment">//     NGX_MAIN_CONF|NGX_CONF_BLOCK|NGX_CONF_NOARGS,</span></span><br><span class="line">        <span class="comment">//     ngx_http_block,</span></span><br><span class="line">        <span class="comment">//     0,</span></span><br><span class="line">        <span class="comment">//     0,</span></span><br><span class="line">        <span class="comment">//     NULL &#125;,</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//     ngx_null_command</span></span><br><span class="line">        <span class="comment">// &#125;;</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_strcmp(name-&gt;data, cmd-&gt;name.data) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        found = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[i]-&gt;type != NGX_CONF_MODULE</span><br><span class="line">            &amp;&amp; cf-&gt;cycle-&gt;modules[i]-&gt;type != cf-&gt;module_type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* is the directive&#x27;s location right ? */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(cmd-&gt;type &amp; cf-&gt;cmd_type)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_OK) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                <span class="string">&quot;directive \&quot;%s\&quot; is not terminated by \&quot;;\&quot;&quot;</span>,</span><br><span class="line">                                name-&gt;data);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((cmd-&gt;type &amp; NGX_CONF_BLOCK) &amp;&amp; last != NGX_CONF_BLOCK_START) &#123;</span><br><span class="line">            ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                                <span class="string">&quot;directive \&quot;%s\&quot; has no opening \&quot;&#123;\&quot;&quot;</span>,</span><br><span class="line">                                name-&gt;data);</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* is the directive&#x27;s argument count right ? */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(cmd-&gt;type &amp; NGX_CONF_ANY)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_FLAG) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 指令要求至少一个参数</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_1MORE) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 指令要求至少两个参数</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_CONF_2MORE) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> invalid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;args-&gt;nelts &gt; NGX_CONF_MAX_ARGS) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> invalid;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(cmd-&gt;type &amp; argument_number[cf-&gt;args-&gt;nelts - <span class="number">1</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">goto</span> invalid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* set up the directive&#x27;s configuration context */</span></span><br><span class="line"></span><br><span class="line">        conf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_DIRECT_CONF) &#123;</span><br><span class="line">            <span class="comment">// 将conf赋为上文调用create_conf初始化好的数组地址</span></span><br><span class="line">            conf = ((<span class="type">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index];</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd-&gt;type &amp; NGX_MAIN_CONF) &#123;</span><br><span class="line">            <span class="comment">// 将conf赋为上文调用create_conf初始化好的数组地址</span></span><br><span class="line">            conf = &amp;(((<span class="type">void</span> **) cf-&gt;ctx)[cf-&gt;cycle-&gt;modules[i]-&gt;index]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cf-&gt;ctx) &#123;</span><br><span class="line">            <span class="comment">// 举个例子</span></span><br><span class="line">            <span class="comment">// 在 ngx_stream block解析过程中，cf-&gt;ctx 指向 ngx_stream_conf_ctx_t</span></span><br><span class="line">            <span class="comment">// 如果 cmd-&gt;conf 为 NGX_STREAM_SRV_CONF_OFFSET（8）</span></span><br><span class="line">            <span class="comment">// 则 (char *) cf-&gt;ctx + cmd-&gt;conf 计算后指向  ngx_stream_conf_ctx_t#srv_conf 字段.</span></span><br><span class="line">            <span class="comment">// 此种情况下，下面的 conf = confp[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index]; 计算为此module在stream module 的 srv 配置结构，也就是module#create_srv_conf hook 返回的结构</span></span><br><span class="line">            confp = *(<span class="type">void</span> **) ((<span class="type">char</span> *) cf-&gt;ctx + cmd-&gt;conf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (confp) &#123;</span><br><span class="line">                <span class="comment">// 将conf赋为上文调用create_conf初始化好的数组地址</span></span><br><span class="line">                conf = confp[cf-&gt;cycle-&gt;modules[i]-&gt;ctx_index];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用 set，module接管directive处理</span></span><br><span class="line">        <span class="comment">// 如果cmd-&gt;name == &quot;http&quot; &amp;&amp; NGX_CONF_BLOCK</span></span><br><span class="line">        <span class="comment">// 则会走到</span></span><br><span class="line">        <span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/1db517fb71aed6d6fffc8347086f89eb29b83dea/src/http/ngx_http.c#L122</span></span><br><span class="line">        <span class="comment">// http block 创建用于http的配置格式</span></span><br><span class="line">        <span class="comment">// 为什么 ngx_conf_t 里多是 void* p</span></span><br><span class="line">        <span class="comment">// 是因为不同的module要求的配置格式不尽相同，所以留给module自定义</span></span><br><span class="line">        rv = cmd-&gt;<span class="built_in">set</span>(cf, cmd, conf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rv == NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rv == NGX_CONF_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_conf_log_error(NGX_LOG_EMERG, cf, <span class="number">0</span>,</span><br><span class="line">                            <span class="string">&quot;\&quot;%s\&quot; directive %s&quot;</span>, name-&gt;data, rv);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>conf 字段决定set函数的第三个参数传递什么，如果是 NGX_STREAM_SRV_CONF_OFFSET，则nginx会将此module的srv_conf 作为 <code>void *conf</code> 传入set 回调函数传递</p>
<p>我们拿一个set函数举例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_set_worker_processes</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd, <span class="type">void</span> *conf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_str_t</span>        *value;</span><br><span class="line">    <span class="type">ngx_core_conf_t</span>  *ccf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为module自己的conf类型</span></span><br><span class="line">    ccf = (<span class="type">ngx_core_conf_t</span> *) conf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;worker_processes != NGX_CONF_UNSET) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;is duplicate&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置配置</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_strcmp(value[<span class="number">1</span>].data, <span class="string">&quot;auto&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        ccf-&gt;worker_processes = ngx_ncpu;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ccf-&gt;worker_processes = ngx_atoi(value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ccf-&gt;worker_processes == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;invalid value&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_conf_t是在nginx启动后创建的变量，用于配置解析和调用module hook时记录当前配置解析的状态上下文。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/willdeeper/tengine/blob/f9a582f73a2d6bd4fb73270cb6636e3490fc943f/src/core/ngx_conf_file.c#L761</span></span><br><span class="line"><span class="keyword">if</span> (found) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 配置解析过程中，会将指令后的Args存入 cf-&gt;args</span></span><br><span class="line">    <span class="comment">// 调用 module command[] 初始化command值时传入</span></span><br><span class="line">    <span class="comment">// char               *(*set)(ngx_conf_t *cf, ngx_command_t *cmd, void *conf);</span></span><br><span class="line">    word = ngx_array_push(cf-&gt;args);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (word == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    word-&gt;data = ngx_pnalloc(cf-&gt;pool, b-&gt;pos - <span class="number">1</span> - start + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (word-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://user-images.githubusercontent.com/24750337/186622825-8cc33160-bc89-4dc0-98ff-6307df27d683.png" alt="" style="max-width: 400px;width: 100%;"></p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dev/development_guide.html#http_conf">http://nginx.org/en/docs/dev/development_guide.html#http_conf</a></p>
<h3 id="main-conf-vs-srv-conf-vs-loc-conf">main_conf vs srv_conf vs loc_conf</h3>
<p>对于http 模块</p>
<p>main_conf: 应用于整个http block，属于module的全局http配置<br>
srv_conf: 应用于单独一个server block，属于单独某个server块的配置<br>
loc_conf: 应用于单独一个location，属于单独某个location块的配置</p>
<p>所以 main_conf 只有一个，而 srv_conf, loc_conf 都有多个。</p>
<p>所以 create_main_conf 只被调用一次， create_srv, create_loc 可被调用多次，取决于配置中有多少个 server，location block</p>
<p>对于 stream 模块</p>
<p>main_conf: 应用于整个stream block，属于module的全局stream配置<br>
srv_conf: 应用于单独一个server block，属于单独某个server块的配置</p>
<p>所以 main_conf 只有一个，而 srv_conf都有多个。</p>
<p>所以 create_main_conf 只被调用一次， create_srv_conf 可被调用多次，取决于配置中有多少个 server block。</p>
<p>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream foo &#123;</span><br><span class="line">        server 1;</span><br><span class="line">        server 2;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    upstream foo &#123;</span><br><span class="line">        server 1;</span><br><span class="line">        server 2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ngx_command_t</span> ngx_stream_upstream_dynamic_command[] = &#123;</span><br><span class="line">    &#123;ngx_string(<span class="string">&quot;consul&quot;</span>), NGX_STREAM_UPS_CONF | NGX_CONF_1MORE,</span><br><span class="line">     ngx_stream_dynamic_upstream_set_consul_slot, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">    ngx_null_command&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于有 <code>NGX_STREAM_UPS_CONF</code> 标记，配置解析到foo，bar时，分别都会调用module的create_srv_conf</p>
<h2 id="配置merge">配置merge</h2>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dev/development_guide.html#http_conf">http://nginx.org/en/docs/dev/development_guide.html#http_conf</a></p>
<p>以 <code>create_loc_conf</code> 为例，对于module有 create_conf和merge_conf的hook，nginx首先调用 create_conf，此时module创建一个空conf返回给nginx，在merge阶段nginx调用 merge_conf hook，将parent context conf传过来，module就可以拿到配置文件初始化</p>
<p>比如下面的合并server block，<code>cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]</code> 是新创建的 conf，<code>saved.srv_conf[ctx_index]</code>是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (module-&gt;merge_srv_conf) &#123;</span><br><span class="line">    <span class="comment">// https://developer.huawei.com/consumer/cn/forum/topic/0201187160465810231?fid=26</span></span><br><span class="line">    <span class="comment">// 这里主要是进行配置的合并，saved.srv_conf[ctx_index]指向的是http块中解析出的SRV类型的配置，</span></span><br><span class="line">    <span class="comment">// cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]解析的则是当前server块中的配置，合并的一般规则是通过对应</span></span><br><span class="line">    <span class="comment">// 模块实现的merge_srv_conf()来进行的，**决定使用http块中的配置，还是使用server块中的配置**，</span></span><br><span class="line">    <span class="comment">// 或者说合并两者，则是由具体的实现来决定的。这里合并的效果本质上就是对</span></span><br><span class="line">    <span class="comment">// cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]中的属性赋值，如果该值不存在，则将http块对应的值写到该属性中</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指令合并策略并没有强制要求，否则NGINX不会暴露merge_srv_conf的hook</span></span><br><span class="line">    <span class="comment">// 但对于树形结构的配置，指令出现在parent语义上要对child生效，除非child自身也有指令</span></span><br><span class="line">    <span class="comment">// 比如access_log，可以在http_main_block, server block 出现</span></span><br><span class="line">    <span class="comment">// 合并策略是：如果child此项配置为默认值，且parent有配置，child就需要使用parent的配置</span></span><br><span class="line">    <span class="comment">// 这也是大多数配置项合并代码都长得差不多的原因</span></span><br><span class="line">    <span class="comment">// /foo 开启</span></span><br><span class="line">    <span class="comment">// /bar 由于没有access_log配置，被parent merge，所以关闭</span></span><br><span class="line">    <span class="comment">// server &#123;</span></span><br><span class="line">    <span class="comment">//    access_log off;</span></span><br><span class="line">    <span class="comment">//    location /foo &#123;</span></span><br><span class="line">    <span class="comment">//        access_log /data/access.log debug;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//    location /bar &#123;</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为什么 http main block也有loc_conf，毕竟main block和 loc_conf 还隔了一个 srv_conf?</span></span><br><span class="line">    <span class="comment">// 还拿上面的access_log举例，/bar 没有access_log指令，但模块hook早已经注入nginx，所以/bar的 loc module 也需要有 access_log 的 loc_conf，这个配置是从http block parent merge到 loc 的loc_conf的。</span></span><br><span class="line">    <span class="comment">// 一句话：parent的配置不会真正用到，只是给配置初始化阶段child准备</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// call ngx_http_core_merge_srv_conf</span></span><br><span class="line">    rv = module-&gt;merge_srv_conf(cf, saved.srv_conf[ctx_index],</span><br><span class="line">                                cscfp[s]-&gt;ctx-&gt;srv_conf[ctx_index]);</span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于http block，最关键的是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>        **main_conf;</span><br><span class="line">    <span class="type">void</span>        **srv_conf;</span><br><span class="line">    <span class="type">void</span>        **loc_conf;</span><br><span class="line">&#125; <span class="type">ngx_http_conf_ctx_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* array of the ngx_http_server_name_t, &quot;server_name&quot; directive */</span></span><br><span class="line">    <span class="type">ngx_array_t</span>                 server_names;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* server ctx */</span></span><br><span class="line">    <span class="comment">// 每个server块持有 ngx_http_conf_ctx_t 结构，承上启下，server块记录属于哪个http，由记录其下全部的loc_conf</span></span><br><span class="line">    <span class="type">ngx_http_conf_ctx_t</span>        *ctx;</span><br><span class="line"></span><br><span class="line">    u_char                     *file_name;</span><br><span class="line">    <span class="type">ngx_uint_t</span>                  line;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_str_t</span>                   server_name;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span>                      connection_pool_size;</span><br><span class="line">    <span class="type">size_t</span>                      request_pool_size;</span><br><span class="line">    <span class="type">size_t</span>                      client_header_buffer_size;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_bufs_t</span>                  large_client_header_buffers;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_msec_t</span>                  client_header_timeout;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_flag_t</span>                  ignore_invalid_headers;</span><br><span class="line">    <span class="type">ngx_flag_t</span>                  merge_slashes;</span><br><span class="line">    <span class="type">ngx_flag_t</span>                  underscores_in_headers;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span>                    listen:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="type">unsigned</span>                    captures:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_http_core_loc_conf_t</span>  **named_locations;</span><br><span class="line">&#125; <span class="type">ngx_http_core_srv_conf_t</span>;</span><br></pre></td></tr></table></figure>
<p>http block 中开始初始化 http module，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/1db517fb71aed6d6fffc8347086f89eb29b83dea/src/http/ngx_http.c#L154</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* the http main_conf context, it is the same in the all http contexts */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 main_conf</span></span><br><span class="line">ctx-&gt;main_conf = ngx_pcalloc(cf-&gt;pool,</span><br><span class="line">                                <span class="keyword">sizeof</span>(<span class="type">void</span> *) * ngx_http_max_module);</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;main_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * the http null srv_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">    * the server&#123;&#125;s&#x27; srv_conf&#x27;s</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">// 初始化 srv_conf</span></span><br><span class="line">ctx-&gt;srv_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">void</span> *) * ngx_http_max_module);</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;srv_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * the http null loc_conf context, it is used to merge</span></span><br><span class="line"><span class="comment">    * the server&#123;&#125;s&#x27; loc_conf&#x27;s</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="comment">// 初始化 loc_conf</span></span><br><span class="line">ctx-&gt;loc_conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">void</span> *) * ngx_http_max_module);</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;loc_conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * create the main_conf&#x27;s, the null srv_conf&#x27;s, and the null loc_conf&#x27;s</span></span><br><span class="line"><span class="comment">    * of the all http modules</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="comment">// 只处理 http module</span></span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从cycle中取出 ngx_module_t#ctx void* p 指针</span></span><br><span class="line">    module = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">    mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 http module hook</span></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;create_main_conf) &#123;</span><br><span class="line">        ctx-&gt;main_conf[mi] = module-&gt;create_main_conf(cf);</span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;main_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用 http module hook</span></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;create_srv_conf) &#123;</span><br><span class="line">        ctx-&gt;srv_conf[mi] = module-&gt;create_srv_conf(cf);</span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;srv_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用 http module hook</span></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;create_loc_conf) &#123;</span><br><span class="line">        ctx-&gt;loc_conf[mi] = module-&gt;create_loc_conf(cf);</span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;loc_conf[mi] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意这里，pcf 不是pointer，是clone了一份 cf</span></span><br><span class="line"><span class="comment">// 而cf-&gt;ctx 被覆盖成 ngx_http_conf_ctx_t 结构</span></span><br><span class="line"><span class="comment">// ngx_conf_t 的ctx应该指向 modules的数组，这里临时修改了指向hack了下。主要是为了http postconfiguration 和 config merge</span></span><br><span class="line"><span class="comment">// 在此函数最后 *cf = pcf</span></span><br><span class="line">pcf = *cf;</span><br><span class="line">cf-&gt;ctx = ctx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;preconfiguration) &#123;</span><br><span class="line">        <span class="keyword">if</span> (module-&gt;preconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* parse inside the http&#123;&#125; block */</span></span><br><span class="line"></span><br><span class="line">cf-&gt;module_type = NGX_HTTP_MODULE;</span><br><span class="line">cf-&gt;cmd_type = NGX_HTTP_MAIN_CONF;</span><br><span class="line">rv = ngx_conf_parse(cf, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">    <span class="keyword">goto</span> failed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * init http&#123;&#125; main_conf&#x27;s, merge the server&#123;&#125;s&#x27; srv_conf&#x27;s</span></span><br><span class="line"><span class="comment">    * and its location&#123;&#125;s&#x27; loc_conf&#x27;s</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">cmcf = ctx-&gt;main_conf[ngx_http_core_module.ctx_index];</span><br><span class="line">cscfp = cmcf-&gt;servers.elts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line">    mi = cf-&gt;cycle-&gt;modules[m]-&gt;ctx_index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* init http&#123;&#125; main_conf&#x27;s */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;init_main_conf) &#123;</span><br><span class="line">        rv = module-&gt;init_main_conf(cf, ctx-&gt;main_conf[mi]);</span><br><span class="line">        <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rv = ngx_http_merge_servers(cf, cmcf, module, mi);</span><br><span class="line">    <span class="keyword">if</span> (rv != NGX_CONF_OK) &#123;</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* create location trees */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; cmcf-&gt;servers.nelts; s++) &#123;</span><br><span class="line"></span><br><span class="line">    clcf = cscfp[s]-&gt;ctx-&gt;loc_conf[ngx_http_core_module.ctx_index];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_locations(cf, cscfp[s], clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_init_static_location_trees(cf, clcf) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_phases(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ngx_http_init_headers_in_hash(cf, cmcf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (m = <span class="number">0</span>; cf-&gt;cycle-&gt;modules[m]; m++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cf-&gt;cycle-&gt;modules[m]-&gt;type != NGX_HTTP_MODULE) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module = cf-&gt;cycle-&gt;modules[m]-&gt;ctx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (module-&gt;postconfiguration) &#123;</span><br><span class="line">        <span class="keyword">if</span> (module-&gt;postconfiguration(cf) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ngx_http_variables_init_vars(cf) != NGX_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * http&#123;&#125;&#x27;s cf-&gt;ctx was needed while the configuration merging</span></span><br><span class="line"><span class="comment">    * and in postconfiguration process</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// **看这里**</span></span><br><span class="line"><span class="comment">// 在 ngx_http_merge_servers 和 postconfiguration 之后，ctx又还原重新指向 modules 指针数组</span></span><br><span class="line">*cf = pcf;</span><br></pre></td></tr></table></figure>
<h3 id="merge-loc-conf">merge_loc_conf</h3>
<p>需要location merge是因为 location 可以嵌套</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># main context</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    </span><br><span class="line">    # server context</span><br><span class="line"></span><br><span class="line">    location /match/criteria &#123;</span><br><span class="line"></span><br><span class="line">        # first location context</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /other/criteria &#123;</span><br><span class="line"></span><br><span class="line">        # second location context</span><br><span class="line"></span><br><span class="line">        location nested_match &#123;</span><br><span class="line"></span><br><span class="line">            # first nested location</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location other_nested &#123;</span><br><span class="line"></span><br><span class="line">            # second nested location</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Http-请求处理">Http 请求处理</h2>
<h3 id="Phase">Phase</h3>
<p>Nginx将请求分成如下几个阶段，请求到来后，按照顺序分别执行每个阶段的handlers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    NGX_HTTP_POST_READ_PHASE = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_SERVER_REWRITE_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_FIND_CONFIG_PHASE,</span><br><span class="line">    NGX_HTTP_REWRITE_PHASE,</span><br><span class="line">    NGX_HTTP_POST_REWRITE_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_PREACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_ACCESS_PHASE,</span><br><span class="line">    NGX_HTTP_POST_ACCESS_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_PRECONTENT_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_CONTENT_PHASE,</span><br><span class="line"></span><br><span class="line">    NGX_HTTP_LOG_PHASE</span><br><span class="line">&#125; ngx_http_phases;</span><br></pre></td></tr></table></figure>
<p>由于nginx支持module插件的形式，必然要有一种机制，当请求来后遍历执行插件，可以在中间某个插件停止处理</p>
<p>Koa 使用洋葱模型，nginx则while迭代handler，handler里决定是否 <code>r-&gt;phase_handler++</code>指向下一个handler，如果handler返回 <code>NGX_OK</code>，则请求处理结束</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/http/ngx_http_core_module.c#L875</span></span><br><span class="line"><span class="keyword">while</span> (ph[r-&gt;phase_handler].checker) &#123;</span><br><span class="line"></span><br><span class="line">    rc = ph[r-&gt;phase_handler].checker(r, &amp;ph[r-&gt;phase_handler]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>http core module 初始化阶段会将不同module挂载到不同phase上，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/http/ngx_http.c#L486</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_HTTP_LOG_PHASE; i++) &#123;</span><br><span class="line">    h = cmcf-&gt;phases[i].handlers.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="comment">// 内置module 通过for loop 放到不同phase</span></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_SERVER_REWRITE_PHASE:</span><br><span class="line">        <span class="keyword">if</span> (cmcf-&gt;phase_engine.server_rewrite_index == (<span class="type">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">            cmcf-&gt;phase_engine.server_rewrite_index = n;</span><br><span class="line">        &#125;</span><br><span class="line">        checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_FIND_CONFIG_PHASE:</span><br><span class="line">        find_config_index = n;</span><br><span class="line"></span><br><span class="line">        ph-&gt;checker = ngx_http_core_find_config_phase;</span><br><span class="line">        n++;</span><br><span class="line">        ph++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_REWRITE_PHASE:</span><br><span class="line">        <span class="keyword">if</span> (cmcf-&gt;phase_engine.location_rewrite_index == (<span class="type">ngx_uint_t</span>) <span class="number">-1</span>) &#123;</span><br><span class="line">            cmcf-&gt;phase_engine.location_rewrite_index = n;</span><br><span class="line">        &#125;</span><br><span class="line">        checker = ngx_http_core_rewrite_phase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_POST_REWRITE_PHASE:</span><br><span class="line">        <span class="keyword">if</span> (use_rewrite) &#123;</span><br><span class="line">            ph-&gt;checker = ngx_http_core_post_rewrite_phase;</span><br><span class="line">            ph-&gt;next = find_config_index;</span><br><span class="line">            n++;</span><br><span class="line">            ph++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_ACCESS_PHASE:</span><br><span class="line">        checker = ngx_http_core_access_phase;</span><br><span class="line">        n++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_POST_ACCESS_PHASE:</span><br><span class="line">        <span class="keyword">if</span> (use_access) &#123;</span><br><span class="line">            ph-&gt;checker = ngx_http_core_post_access_phase;</span><br><span class="line">            ph-&gt;next = n;</span><br><span class="line">            ph++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_HTTP_CONTENT_PHASE:</span><br><span class="line">        checker = ngx_http_core_content_phase;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        checker = ngx_http_core_generic_phase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = cmcf-&gt;phases[i].handlers.nelts - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">        ph-&gt;checker = checker;</span><br><span class="line">        ph-&gt;handler = h[j];</span><br><span class="line">        ph-&gt;next = n;</span><br><span class="line">        ph++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Stream-module-hook-调用顺序">Stream module hook 调用顺序</h2>
<p>先看一个第三方 stream module的 ctx 结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_int_t</span>                    (*preconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">ngx_int_t</span>                    (*postconfiguration)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                        *(*create_main_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>                        *(*init_main_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *conf);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                        *(*create_srv_conf)(<span class="type">ngx_conf_t</span> *cf);</span><br><span class="line">    <span class="type">char</span>                        *(*merge_srv_conf)(<span class="type">ngx_conf_t</span> *cf, <span class="type">void</span> *prev,</span><br><span class="line">                                                   <span class="type">void</span> *conf);</span><br><span class="line">&#125; <span class="type">ngx_stream_module_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_stream_module_t</span>  ngx_stream_upsync_module_ctx = &#123;</span><br><span class="line">    <span class="literal">NULL</span>,                                       <span class="comment">/* preconfiguration */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                       <span class="comment">/* postconfiguration */</span></span><br><span class="line"></span><br><span class="line">    ngx_stream_upsync_create_main_conf,         <span class="comment">/* create main configuration */</span></span><br><span class="line">    ngx_stream_upsync_init_main_conf,           <span class="comment">/* init main configuration */</span></span><br><span class="line"></span><br><span class="line">    ngx_stream_upsync_create_srv_conf,          <span class="comment">/* create server configuration */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                       <span class="comment">/* merge server configuration */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>调用顺序</p>
<ol>
<li>create_main_conf：创建module自己的配置文件struct并返回</li>
<li>create_srv_conf<br>
创建server块的module 配置。举个例子：stream block下会有server block，此时会调用 create_srv_conf，放到 srv_conf 下的module对应的数组索引中。upstream block下也有 server block，也会调用 create_srv_conf，放到 srv_conf 下的module对应的数组索引中。所以 create_srv_conf 会在stream block和upstream block都调用。</li>
<li>preconfiguration: 配置创建之前</li>
<li>postconfiguration: 配置创建之后，但还未基于配置进行其他的行为。http request handler就放这里。nginx会将handler放入phase_engine，再往下放handler已经晚了<br>
到此 nginx 已经完成 upstream，server 块、module 的command/directive 解析。由于每个command都有set hook，set里都已经将value放到了之前创建的 conf 中</li>
<li>create_main_conf</li>
<li>create_srv_conf：server块配置初始化<br>
// 配置初始化完成后，下面开始调用 ngx_module_t 上的 module 级别的hook</li>
<li>create_loc_conf</li>
<li>init_main_conf<br>
nginx 将 module 自己创建好的 conf 传进来，module 初始化自身配置</li>
<li>merge_srv_conf: 有些指令可以在main block，也可以在 srv block，merge_srv_conf 的hook决定srv block的conf是否需要覆盖main block的。由于传递的是指针，也可以顺带修改main block的指令参数</li>
<li>init_module:<br>
每次配置文件reload，init_module都会被重新掉用，传进来 cycle，cycle-&gt;old_cycle，用于生成一个新cycle。最后创建好的cycle放在全局变量中，fork 新worker process后，cycle 会自动映射到worker process 地址空间，访问时写时拷贝。</li>
<li>init_process<br>
只在 worker process 调用。请求不经过master直接到worker，此hook可以执行module的业务逻辑，初始化处理请求相关的配置。比如 <code>nginx-stream-upsync-module</code>，在 init_process 里请求consul，etcd，获取下游ipport列表，放在worker自己的变量中</li>
<li>exit_process<br>
worker退出调用</li>
<li>exit_master<br>
master退出时掉用，优雅退出</li>
</ol>
<h2 id="Stream-请求处理">Stream 请求处理</h2>
<h3 id="Phase-2">Phase</h3>
<p>如下几个阶段，顺序执行每个阶段下的handlers<br>
<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/stream/stream_processing.html">http://nginx.org/en/docs/stream/stream_processing.html</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    NGX_STREAM_POST_ACCEPT_PHASE = <span class="number">0</span>,</span><br><span class="line">    NGX_STREAM_PREACCESS_PHASE,</span><br><span class="line">    NGX_STREAM_ACCESS_PHASE ,</span><br><span class="line">    NGX_STREAM_SSL_PHASE,</span><br><span class="line">    NGX_STREAM_PREREAD_PHASE,</span><br><span class="line">    NGX_STREAM_CONTENT_PHASE,</span><br><span class="line">    NGX_STREAM_LOG_PHASE</span><br><span class="line">&#125; ngx_stream_phases;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/stream/ngx_stream.c#L352</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NGX_STREAM_LOG_PHASE; i++) &#123;</span><br><span class="line">    h = cmcf-&gt;phases[i].handlers.elts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">    <span class="comment">// stream module 将内置handlers放到不同的phase</span></span><br><span class="line">    <span class="keyword">case</span> NGX_STREAM_PREREAD_PHASE:</span><br><span class="line">        checker = ngx_stream_core_preread_phase;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_STREAM_CONTENT_PHASE:</span><br><span class="line">        ph-&gt;checker = ngx_stream_core_content_phase;</span><br><span class="line">        n++;</span><br><span class="line">        ph++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        checker = ngx_stream_core_generic_phase;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n += cmcf-&gt;phases[i].handlers.nelts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = cmcf-&gt;phases[i].handlers.nelts - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">        ph-&gt;checker = checker;</span><br><span class="line">        ph-&gt;handler = h[j];</span><br><span class="line">        ph-&gt;next = n;</span><br><span class="line">        ph++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="stream-upstream-module-分析与负载均衡逻辑">stream upstream module 分析与负载均衡逻辑</h2>
<p>upstream作为nginx的LB模块，承担着在server中流量均分的重任。</p>
<p>分析upstream module中，必然绕不开以下几个结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ngx_stream_upstream_server_t</span>    *server = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// rr 为 round robin 简写</span></span><br><span class="line"><span class="type">ngx_stream_upstream_rr_peer_t</span>   *peer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">ngx_stream_upstream_rr_peers_t</span>  *peers = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">ngx_stream_upstream_srv_conf_t</span>  *uscf;</span><br></pre></td></tr></table></figure>
<p>通过 upstream block 对齐到上面类型</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="comment"># ngx_stream_upstream_srv_conf_t</span></span><br><span class="line">    <span class="comment"># ngx_stream_upstream_rr_peers_t</span></span><br><span class="line">    <span class="section">upstream</span> a.b.c&#123;</span><br><span class="line">        <span class="comment"># ngx_stream_upstream_server_t</span></span><br><span class="line">        <span class="comment"># ngx_stream_upstream_rr_peer_t</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:12345</span>            max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="comment"># ngx_stream_upstream_server_t</span></span><br><span class="line">        <span class="comment"># ngx_stream_upstream_peer_t</span></span><br><span class="line">        <span class="attribute">server</span> unix:/tmp/backend3;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">1.2.3.4:8080</span> backup;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">5.6.7.8:8080</span> backup;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">12345</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">1s</span>;</span><br><span class="line">        <span class="attribute">proxy_timeout</span> <span class="number">3s</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ngx_stream_upstream_srv_conf_t 存放 upstream block 级别的相关配置<br>
ngx_stream_upstream_server_t 存放 upstream 单独一个server block配置，含有 <code>weight, max_fails</code> 等配置</p>
<p><code>ngx_stream_upstream_rr_peers_t</code>, <code>ngx_stream_upstream_rr_peer_t</code> 与 round robin 相关</p>
<p>peer_t 记录LB相关参数，比如已经连接到此下游的连接数，下游响应时间，用于进行LB策略<br>
peers_t#next参数和upstream 的backup指令有关，记录此peers_t的backup servers</p>
<p>当peer_t down，peers_t通过next找到此peer_t的backup peers，再通过 backup peers 找到 backup peer_t</p>
<p>ngx_stream_upstream_rr_peers_s 结构注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">struct ngx_stream_upstream_rr_peers_s &#123;</span><br><span class="line">    ngx_uint_t                       number; // 下游服务器数量</span><br><span class="line"></span><br><span class="line">#if (NGX_STREAM_UPSTREAM_ZONE)</span><br><span class="line">    ngx_slab_pool_t                 *shpool;</span><br><span class="line">    ngx_atomic_t                     rwlock;</span><br><span class="line">    ngx_stream_upstream_rr_peers_t  *zone_next;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    ngx_uint_t                       total_weight; // 所有服务器总权重</span><br><span class="line"></span><br><span class="line">    unsigned                         single:1; // 此upstream只有一台下游</span><br><span class="line">    unsigned                         weighted:1;</span><br><span class="line"></span><br><span class="line">    ngx_str_t                       *name;</span><br><span class="line"></span><br><span class="line">    ngx_stream_upstream_rr_peers_t  *next; // 存放全部backups下游</span><br><span class="line"></span><br><span class="line">    ngx_stream_upstream_rr_peer_t   *peer; // 存放全部下游</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ngx_stream_upstream_rr_peer_s 结构注释</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_stream_upstream_rr_peer_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span>                 *<span class="title">sockaddr</span>;</span> <span class="comment">// 后端地址</span></span><br><span class="line">    <span class="type">socklen_t</span>                        socklen; <span class="comment">// 后端地址长度</span></span><br><span class="line">    <span class="type">ngx_str_t</span>                        name; <span class="comment">// 后端名称</span></span><br><span class="line">    <span class="type">ngx_str_t</span>                        server;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_int_t</span>                        current_weight; <span class="comment">// 当前权重，运行中动态调整</span></span><br><span class="line">    <span class="type">ngx_int_t</span>                        effective_weight;</span><br><span class="line">    <span class="type">ngx_int_t</span>                        weight; <span class="comment">// 配置的权重</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>                       conns;</span><br><span class="line">    <span class="type">ngx_uint_t</span>                       max_conns;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>                       fails;</span><br><span class="line">    <span class="type">time_t</span>                           accessed;</span><br><span class="line">    <span class="type">time_t</span>                           checked;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>                       max_fails; <span class="comment">// 最大失败次数</span></span><br><span class="line">    <span class="type">time_t</span>                           fail_timeout; <span class="comment">// 多长时间内出现max_fails次失败，认为后端down</span></span><br><span class="line">    <span class="type">ngx_msec_t</span>                       slow_start;</span><br><span class="line">    <span class="type">ngx_msec_t</span>                       start_time;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_uint_t</span>                       down; <span class="comment">// 指定此后端down</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                            *ssl_session;</span><br><span class="line">    <span class="type">int</span>                              ssl_session_len;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_STREAM_UPSTREAM_ZONE)</span></span><br><span class="line">    <span class="type">ngx_atomic_t</span>                     lock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_stream_upstream_rr_peer_t</span>   *next;</span><br><span class="line"></span><br><span class="line">    NGX_COMPAT_BEGIN(<span class="number">25</span>)</span><br><span class="line">    NGX_COMPAT_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://user-images.githubusercontent.com/24750337/188052512-c07e011e-760d-42bb-9e3e-194c90f1e3e1.png" alt="" style="max-width: 400px;width: 100%;"></p>
<h2 id="部分nginx-struct剖析">部分nginx struct剖析</h2>
<h3 id="ngx-command-t">ngx_command_t</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_command_s</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_str_t</span>             name;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            type;</span><br><span class="line">    <span class="type">char</span>               *(*<span class="built_in">set</span>)(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd, <span class="type">void</span> *conf);</span><br><span class="line">    <span class="type">ngx_uint_t</span>            conf;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            offset;</span><br><span class="line">    <span class="type">void</span>                 *post;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_command_t</span>  ngx_http_dubbo_commands[] = &#123;</span><br><span class="line"></span><br><span class="line">    &#123; ngx_string(<span class="string">&quot;dubbo_pass&quot;</span>), <span class="comment">// name</span></span><br><span class="line">      NGX_HTTP_LOC_CONF|NGX_HTTP_LIF_CONF|NGX_CONF_TAKE4, <span class="comment">// type</span></span><br><span class="line">      ngx_http_dubbo_pass, <span class="comment">// set</span></span><br><span class="line">      NGX_HTTP_LOC_CONF_OFFSET, <span class="comment">// conf</span></span><br><span class="line">      <span class="number">0</span>, <span class="comment">// offset</span></span><br><span class="line">      <span class="literal">NULL</span> <span class="comment">/* post */</span>&#125;,</span><br><span class="line">      ngx_null_command</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>nginx回调set(ngx_http_dubbo_pass)，并根据 <code>.conf（NGX_HTTP_LOC_CONF_OFFSET）</code>，设置 cf-&gt;ctx</p>
<p>offset 只有和 set 配合才有意义。nginx有很多需要将配置项存放到结构体的需求，所以nginx提供了形如 ngx_conf_set_foo_slot 的函数，用于批量解决此需求。</p>
<p>这些ngx_conf_set_foo_slot需要知道将value放到结构体的哪个位置，因此在ngx_command_t上就须填写offset，由nginx计算位置并存放。</p>
<p>当然你完全可以将offset置为0，但这意味着需要针对每条directive都编写set，将 <code>void * conf</code> 转换成具体的结构体类型，通过 <code>a-&gt;b</code>设置。</p>
<p>比如nginx提供的一个函数，通过<code>cmd-&gt;offset</code>获取要set的struct成员并赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_conf_set_num_slot</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd, <span class="type">void</span> *conf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>  *p = conf;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_int_t</span>        *np;</span><br><span class="line">    <span class="type">ngx_str_t</span>        *value;</span><br><span class="line">    <span class="type">ngx_conf_post_t</span>  *post;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    np = (<span class="type">ngx_int_t</span> *) (p + cmd-&gt;offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*np != NGX_CONF_UNSET) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;is duplicate&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    *np = ngx_atoi(value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line">    <span class="keyword">if</span> (*np == NGX_ERROR) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;invalid number&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmd-&gt;post) &#123;</span><br><span class="line">        post = cmd-&gt;post;</span><br><span class="line">        <span class="keyword">return</span> post-&gt;post_handler(cf, post, np);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ngx-conf-t">ngx_conf_t</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_conf_s</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>                 *name;</span><br><span class="line">    <span class="type">ngx_array_t</span>          *args;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_cycle_t</span>          *cycle;</span><br><span class="line">    <span class="type">ngx_pool_t</span>           *pool;</span><br><span class="line">    <span class="type">ngx_pool_t</span>           *temp_pool;</span><br><span class="line">    <span class="type">ngx_conf_file_t</span>      *conf_file;</span><br><span class="line">    <span class="type">ngx_log_t</span>            *<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>                 *ctx;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            module_type;</span><br><span class="line">    <span class="type">ngx_uint_t</span>            cmd_type;</span><br><span class="line"></span><br><span class="line">    ngx_conf_handler_pt   handler;</span><br><span class="line">    <span class="type">void</span>                 *handler_conf;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_SSL &amp;&amp; NGX_SSL_ASYNC)</span></span><br><span class="line">    <span class="type">ngx_flag_t</span>            no_ssl_init;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example module</span></span><br><span class="line"><span class="type">ngx_module_t</span>  ngx_stream_upsync_module = &#123;</span><br><span class="line">    NGX_MODULE_V1,</span><br><span class="line">    &amp;ngx_stream_upsync_module_ctx,               <span class="comment">/* module context */</span></span><br><span class="line">    ngx_stream_upsync_commands,                  <span class="comment">/* module directives */</span></span><br><span class="line">    NGX_STREAM_MODULE,                           <span class="comment">/* module type */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                        <span class="comment">/* init master */</span></span><br><span class="line">    ngx_stream_upsync_init_module,               <span class="comment">/* init module */</span></span><br><span class="line">    ngx_stream_upsync_init_process,              <span class="comment">/* init process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                        <span class="comment">/* init thread */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                        <span class="comment">/* exit thread */</span></span><br><span class="line">    ngx_stream_upsync_clear_all_events,          <span class="comment">/* exit process */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                        <span class="comment">/* exit master */</span></span><br><span class="line">    NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>重点说下 <code>void* ctx</code><br>
ngx_conf_s 在配置解析过程中使用，module type定义了 ctx 存放的类型。上述 ngx_stream_upsync_module 为 stream module，所以解析stream block时，包括 stream upstream 下，ngx_conf_t#ctx总是指向 stream 的 ctx 配置 <code>ngx_stream_conf_ctx_t</code></p>
<h3 id="ngx-str-t">ngx_str_t</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span>      len;</span><br><span class="line">    u_char     *data;</span><br><span class="line">&#125; <span class="type">ngx_str_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>len的长度不一定包含 <code>\0</code>，如果<code>ngx_str_t</code>由字符串常量初始化而来，比如<code>ngx_string(&quot;hello&quot;)</code>， <code>sizeof(&quot;hello&quot;)</code>为 5+1，而此时len却是5，确保一定是null结尾，方便传给syscall</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var-&gt;len = <span class="number">2</span>;</span><br><span class="line">    var-&gt;data = (u_char *) <span class="string">&quot;TZ&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>〉 The <code>len</code> field holds the string length and <code>data</code> holds the string data. The string, held in <code>ngx_str_t</code>, may or may not be null-terminated after the <code>len</code> bytes. In most cases it’s not. However, in certain parts of the code (for example, when parsing configuration), <code>ngx_str_t</code> objects are known to be null-terminated, which simplifies string comparison and makes it easier to pass the strings to syscalls</p>
<h2 id="Module如何注册到Phase，参与请求的处理">Module如何注册到Phase，参与请求的处理</h2>
<p>上文说了 http core module 会在http module初始化中注册到phase，而第三方module则会在<br>
<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dev/development_guide.html#http_phases">http://nginx.org/en/docs/dev/development_guide.html#http_phases</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ngx_http_module_t</span>  ngx_http_foo_module_ctx = &#123;</span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* preconfiguration */</span></span><br><span class="line">    ngx_http_foo_init,                     <span class="comment">/* postconfiguration */</span></span><br><span class="line"></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* create main configuration */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* init main configuration */</span></span><br><span class="line"></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* create server configuration */</span></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* merge server configuration */</span></span><br><span class="line"></span><br><span class="line">    <span class="literal">NULL</span>,                                  <span class="comment">/* create location configuration */</span></span><br><span class="line">    <span class="literal">NULL</span>                                   <span class="comment">/* merge location configuration */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_foo_handler</span><span class="params">(<span class="type">ngx_http_request_t</span> *r)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_str_t</span>  *ua;</span><br><span class="line"></span><br><span class="line">    ua = r-&gt;headers_in-&gt;user_agent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ua == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* reject requests with &quot;User-Agent: foo&quot; */</span></span><br><span class="line">    <span class="keyword">if</span> (ua-&gt;value.len == <span class="number">3</span> &amp;&amp; ngx_strncmp(ua-&gt;value.data, <span class="string">&quot;foo&quot;</span>, <span class="number">3</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_HTTP_FORBIDDEN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_foo_init</span><span class="params">(<span class="type">ngx_conf_t</span> *cf)</span></span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_handler_pt        *h;</span><br><span class="line">    <span class="type">ngx_http_core_main_conf_t</span>  *cmcf;</span><br><span class="line"></span><br><span class="line">    cmcf = ngx_http_conf_get_module_main_conf(cf, ngx_http_core_module);</span><br><span class="line">    <span class="comment">// http://nginx.org/en/docs/dev/development_guide.html#http_phases</span></span><br><span class="line">    <span class="comment">// 将handler放到对应的phase list中</span></span><br><span class="line">    h = ngx_array_push(&amp;cmcf-&gt;phases[NGX_HTTP_PREACCESS_PHASE].handlers);</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *h = ngx_http_foo_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="指令directive">指令directive</h2>
<p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/dev/development_guide.html#config_directives">http://nginx.org/en/docs/dev/development_guide.html#config_directives</a></p>
<h2 id="master发送signal">master发送signal</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/os/unix/ngx_process_cycle.c#L139">https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/os/unix/ngx_process_cycle.c#L139</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line">    <span class="comment">// 省略无关代码...</span></span><br><span class="line">    <span class="comment">// block 在 signal syscall</span></span><br><span class="line">    sigsuspend(&amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_terminate) &#123;</span><br><span class="line">        <span class="keyword">if</span> (delay == <span class="number">0</span>) &#123;</span><br><span class="line">            delay = <span class="number">50</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sigio) &#123;</span><br><span class="line">            sigio--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sigio = ccf-&gt;worker_processes + <span class="number">2</span> <span class="comment">/* cache processes */</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// signal 属于进程间通信</span></span><br><span class="line">        <span class="comment">// 将 signal 发送给worker process</span></span><br><span class="line">        <span class="keyword">if</span> (delay &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            ngx_signal_worker_processes(cycle, SIGKILL);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ngx_signal_worker_processes(cycle,</span><br><span class="line">                                    ngx_signal_value(NGX_TERMINATE_SIGNAL));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略无关代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="worker-process-接受-master-process-signal">worker process 接受 master process signal</h2>
<p>master, worker signal 处理代码都在一起</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/os/unix/ngx_process.c#L319</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (ngx_process) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> NGX_PROCESS_MASTER:</span><br><span class="line"><span class="keyword">case</span> NGX_PROCESS_SINGLE:</span><br><span class="line">    <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_SHUTDOWN_SIGNAL)</span>:</span><br><span class="line">        ngx_quit = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, shutting down&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_TERMINATE_SIGNAL)</span>:</span><br><span class="line">    <span class="keyword">case</span> SIGINT:</span><br><span class="line">        ngx_terminate = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, exiting&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_NOACCEPT_SIGNAL)</span>:</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(ngx_daemonized)</span> &#123;</span><br><span class="line">            ngx_noaccept = <span class="number">1</span>;</span><br><span class="line">            action = <span class="string">&quot;, stop accepting connections&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_RECONFIGURE_SIGNAL)</span>:</span><br><span class="line">        ngx_reconfigure = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, reconfiguring&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_REOPEN_SIGNAL)</span>:</span><br><span class="line">        ngx_reopen = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, reopening logs&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_CHANGEBIN_SIGNAL)</span>:</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(ngx_getppid() == ngx_parent || ngx_new_binary &gt; <span class="number">0</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Ignore the signal in the new binary if its parent is</span></span><br><span class="line"><span class="comment">                * not changed, i.e. the old binary&#x27;s process is still</span></span><br><span class="line"><span class="comment">                * running.  Or ignore the signal in the old binary&#x27;s</span></span><br><span class="line"><span class="comment">                * process if the new binary&#x27;s process is already running.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line"></span><br><span class="line">            action = <span class="string">&quot;, ignoring&quot;</span>;</span><br><span class="line">            ignore = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_change_binary = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, changing binary&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SIGALRM:</span><br><span class="line">        ngx_sigalrm = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SIGIO:</span><br><span class="line">        ngx_sigio = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> SIGCHLD:</span><br><span class="line">        ngx_reap = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> NGX_PROCESS_WORKER:</span><br><span class="line"><span class="keyword">case</span> NGX_PROCESS_HELPER:</span><br><span class="line">    <span class="keyword">switch</span> (signo) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_NOACCEPT_SIGNAL)</span>:</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(!ngx_daemonized)</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ngx_debug_quit = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/* fall through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_SHUTDOWN_SIGNAL)</span>:</span><br><span class="line">        <span class="comment">// worker, helper process 收到 shutdown signal后会设置ngx_quit</span></span><br><span class="line">        <span class="comment">// 而此时 worker 一直在 ngx_worker_process_cycle 函数中，</span></span><br><span class="line">        <span class="comment">// 当检测到 ngx_quit = 1后会关闭listening socket优雅退出</span></span><br><span class="line">        <span class="comment">// https://github.com/taikulawo/nginx-debugable/blob/f02e2a734ef472f0dcf83ab2e8ce96d1acead8a5/src/os/unix/ngx_process_cycle.c#L728</span></span><br><span class="line">        ngx_quit = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, shutting down&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_TERMINATE_SIGNAL)</span>:</span><br><span class="line">    <span class="keyword">case</span> SIGINT:</span><br><span class="line">        ngx_terminate = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, exiting&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_REOPEN_SIGNAL)</span>:</span><br><span class="line">        ngx_reopen = <span class="number">1</span>;</span><br><span class="line">        action = <span class="string">&quot;, reopening logs&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_RECONFIGURE_SIGNAL)</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title function_">ngx_signal_value</span><span class="params">(NGX_CHANGEBIN_SIGNAL)</span>:</span><br><span class="line">    <span class="keyword">case</span> SIGIO:</span><br><span class="line">        action = <span class="string">&quot;, ignoring&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="worker-listen-socket-解决listen冲突">worker listen socket 解决listen冲突</h2>
<p>Linux Kernel 支持 <a target="_blank" rel="noopener" href="https://github.com/taikulawo/nginx-debugable/blob/8a30c4b12226c92cd317db614172cc6de2795768/src/core/ngx_connection.c#L297">SO_REUSEPORT</a>，允许多process accept 同一个socket，socket将按照一定的算法传给不同process</p>
<h2 id="内存池">内存池</h2>
<p>pool并不是说需要内存都从pool里申请，而是在进行一系列操作的时候发现需要频繁申请内存，这时候可以 <code>ngx_create_pool</code> 申请pool，之后这些操作都在此pool中进行。</p>
<p>全部操作都完成后，调用 <code>ngx_destroy_pool</code>就可以。所以 ngx_pfree 并不会释放小内存块</p>
<p>比如我们有个逻辑，heap上存了指向其他heap的pointer，如果为了释放这些内存，就需要每个字段都调用free，如果后期涉及到这里的更改，就必须添加上心字段的free，维护成本很高</p>
<p>而如果采用pool，逻辑都从pool里分配，只需要在逻辑开头create pool，在逻辑结束后destroy pool就可以，<strong>非常好用</strong></p>
<h2 id="http请求运行流程">http请求运行流程</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/willdeeper/tengine/blob/6efc27b8b955201eaad76f76554d0aaa40dac45b/src/http/ngx_http.c#L1729-L1735">https://github.com/willdeeper/tengine/blob/6efc27b8b955201eaad76f76554d0aaa40dac45b/src/http/ngx_http.c#L1729-L1735</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 向 cycle-&gt;listening 添加 `ngx_listening_t*`结构，并注册 ngx_http_init_connection 回调函数</span></span><br><span class="line">ls-&gt;handler = ngx_http_init_connection;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/willdeeper/tengine/blob/3d65186c980559f4a76f0a48ec19933a76834bfc/src/http/ngx_http_request.c#L332">https://github.com/willdeeper/tengine/blob/3d65186c980559f4a76f0a48ec19933a76834bfc/src/http/ngx_http_request.c#L332</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rev = c-&gt;read;</span><br><span class="line"><span class="comment">// 注册 socket on read handler, 用于解析 http request</span></span><br><span class="line">rev-&gt;handler = ngx_http_wait_request_handler;</span><br><span class="line"><span class="comment">// 暂时没有要写的，先置空</span></span><br><span class="line">c-&gt;write-&gt;handler = ngx_http_empty_handler;</span><br></pre></td></tr></table></figure>
<p>ngx_http_wait_request_handler 函数中从socket读取request<br>
<a target="_blank" rel="noopener" href="https://github.com/willdeeper/tengine/blob/3d65186c980559f4a76f0a48ec19933a76834bfc/src/http/ngx_http_request.c#L450">https://github.com/willdeeper/tengine/blob/3d65186c980559f4a76f0a48ec19933a76834bfc/src/http/ngx_http_request.c#L450</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ngx_http_wait_request_handler</span></span><br><span class="line">n = c-&gt;recv(c, b-&gt;last, size);</span><br><span class="line"><span class="comment">// 省略代码.....</span></span><br><span class="line"><span class="comment">// request读取完成，创建 ngx_http_request_t</span></span><br><span class="line">c-&gt;data = ngx_http_create_request(c);</span><br><span class="line"><span class="keyword">if</span> (c-&gt;data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    ngx_http_close_connection(c);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rev-&gt;handler = ngx_http_process_request_line;</span><br><span class="line"><span class="comment">// 开始处理 http 协议</span></span><br><span class="line">ngx_http_process_request_line(rev);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ngx_http_process_request_line</span></span><br><span class="line"><span class="comment">// 处理 header</span></span><br><span class="line">rev-&gt;handler = ngx_http_process_request_headers;</span><br><span class="line">ngx_http_process_request_headers(rev);</span><br></pre></td></tr></table></figure>
<p>http 调用栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_core_run_phases (/data00/codes/tengine/src/http/ngx_http_core_module.c:<span class="number">941</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 走nginx http phase</span></span><br><span class="line">ngx_http_handler (/data00/codes/tengine/src/http/ngx_http_core_module.c:<span class="number">930</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// handler处理结束，之后就是body，request解析完成</span></span><br><span class="line">ngx_http_process_request (/data00/codes/tengine/src/http/ngx_http_request.c:<span class="number">2227</span>)</span><br><span class="line"></span><br><span class="line">处理request header</span><br><span class="line"><span class="title function_">ngx_http_process_request_headers</span> <span class="params">(/data00/codes/tengine/src/http/ngx_http_request.c:<span class="number">1622</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 request line</span></span><br><span class="line"><span class="title function_">ngx_http_process_request_line</span> <span class="params">(/data00/codes/tengine/src/http/ngx_http_request.c:<span class="number">1283</span>)</span></span><br><span class="line"><span class="title function_">ngx_http_wait_request_handler</span> <span class="params">(/data00/codes/tengine/src/http/ngx_http_request.c:<span class="number">535</span>)</span></span><br><span class="line"><span class="title function_">ngx_epoll_process_events</span> <span class="params">(/data00/codes/tengine/src/event/modules/ngx_epoll_module.c:<span class="number">972</span>)</span></span><br><span class="line"><span class="title function_">ngx_process_events_and_timers</span> <span class="params">(/data00/codes/tengine/src/event/ngx_event.c:<span class="number">260</span>)</span></span><br><span class="line"><span class="title function_">ngx_single_process_cycle</span> <span class="params">(/data00/codes/tengine/src/os/unix/ngx_process_cycle.c:<span class="number">346</span>)</span></span><br><span class="line"><span class="title function_">main</span> <span class="params">(/data00/codes/tengine/src/core/nginx.c:<span class="number">415</span>)</span></span><br><span class="line">__<span class="title function_">libc_start_main</span> <span class="params">(@__libc_start_main:<span class="number">61</span>)</span></span><br><span class="line">_<span class="title function_">start</span> <span class="params">(@_start:<span class="number">14</span>)</span></span><br></pre></td></tr></table></figure>
<p>从socket一次recv可能不是完成的http request，就需要暂存已有buffer，并返回，下一次recv从上一次结束处重新开始</p>
<p>当涉及到 NGX_AGAIN，nginx往往都会创建一个struct，将buf保存起来，并保证此函数重入是正确的</p>
<p>比如下面代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_http_process_request_line</span><span class="params">(<span class="type">ngx_event_t</span> *rev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span>              n;</span><br><span class="line">    <span class="type">ngx_int_t</span>            rc, rv;</span><br><span class="line">    <span class="type">ngx_str_t</span>            host;</span><br><span class="line">    <span class="type">ngx_connection_t</span>    *c;</span><br><span class="line">    <span class="type">ngx_http_request_t</span>  *r;</span><br><span class="line"></span><br><span class="line">    c = rev-&gt;data;</span><br><span class="line">    r = c-&gt;data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, rev-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;http process request line&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rev-&gt;timedout) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_INFO, c-&gt;<span class="built_in">log</span>, NGX_ETIMEDOUT, <span class="string">&quot;client timed out&quot;</span>);</span><br><span class="line">        c-&gt;timedout = <span class="number">1</span>;</span><br><span class="line">        ngx_http_close_request(r, NGX_HTTP_REQUEST_TIME_OUT);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = NGX_AGAIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( ;; ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">            <span class="comment">// NGX_AGAIN表示数据不完整，返回，等此函数重新被调用</span></span><br><span class="line">            n = ngx_http_read_request_header(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == NGX_AGAIN || n == NGX_ERROR) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="worker-connections">worker_connections</h3>
<p>worker可以处理的最大连接数，包含client和upstream的连接</p>
<p>比如 client =&gt; nginx =&gt; upstream模型</p>
<p>消耗两个connection</p>
<p>给资源受限的环境准备，现代服务器应尽可能大，比如 10k</p>
<p>整个nginx接受最大连接数为 <code>worker_processes * worker_connections</code></p>
<h3 id="健康检查">健康检查</h3>
<p>nginx可以编译 health check 模块，定期发送HTTP HEAD，确定connection正常使用</p>
<p>nginx 内置的connection检查</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ngx_http_upstream_init_request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!u-&gt;store &amp;&amp; !r-&gt;post_action &amp;&amp; !u-&gt;conf-&gt;ignore_client_abort) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;connection-&gt;read-&gt;ready) &#123;</span><br><span class="line">        ngx_post_event(r-&gt;connection-&gt;read, &amp;ngx_posted_events);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_read_event(r-&gt;connection-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">            ngx_http_finalize_request(r, NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// request初始化阶段就是check broken connection的回调</span></span><br><span class="line">    <span class="comment">// fd read阶段 如果报错，就关掉连接</span></span><br><span class="line">    r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection;</span><br><span class="line">    r-&gt;write_event_handler = ngx_http_upstream_wr_check_broken_connection;</span><br><span class="line">    <span class="comment">// nginx proxy pass要获取upstream连接时，拿到新的连接，再将 read_event_handler 和 write_event_handler改成正常处理数据的handler</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ngx_http_upstream_check_broken_connection</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NOBLOCKING socket，用PEEK读取</span></span><br><span class="line"> n = recv(c-&gt;fd, buf, <span class="number">1</span>, MSG_PEEK);</span><br><span class="line"></span><br><span class="line">err = ngx_socket_errno;</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_HTTP, ev-&gt;<span class="built_in">log</span>, err,</span><br><span class="line">               <span class="string">&quot;http upstream recv(): %d&quot;</span>, n);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ev-&gt;write &amp;&amp; (n &gt;= <span class="number">0</span> || err == NGX_EAGAIN)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((ngx_event_flags &amp; NGX_USE_LEVEL_EVENT) &amp;&amp; ev-&gt;active) &#123;</span><br><span class="line"></span><br><span class="line">    event = ev-&gt;write ? NGX_WRITE_EVENT : NGX_READ_EVENT;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HTTP_SSL &amp;&amp; NGX_SSL_ASYNC)</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;async_enable &amp;&amp; ngx_del_async_conn) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;num_async_fds) &#123;</span><br><span class="line">            ngx_del_async_conn(c, NGX_DISABLE_EVENT);</span><br><span class="line">            c-&gt;num_async_fds--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_del_event(ev, event, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u,</span><br><span class="line">                                           NGX_HTTP_INTERNAL_SERVER_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 读取成功，socket正常，返回</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err == NGX_EAGAIN) &#123;</span><br><span class="line">     <span class="comment">// 如果读取结果是would block，说明socket正常，现在没有数据</span></span><br><span class="line">     <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则socket有问题</span></span><br><span class="line">    ev-&gt;error = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">/* n == 0 */</span></span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag"># 基础</a>
              <a href="/tags/net/" rel="tag"># net</a>
              <a href="/tags/C-C/" rel="tag"># C/C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/24/58/" rel="prev" title="shadowsocks 协议分析及密码学基础">
      <i class="fa fa-chevron-left"></i> shadowsocks 协议分析及密码学基础
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/11/03/63/" rel="next" title="e1000收包callstack分析">
      e1000收包callstack分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-modules%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">nginx modules初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E4%B8%AAhook%E7%9A%84%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="nav-number">1.1.</span> <span class="nav-text">各个hook的调用时机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#init-module"><span class="nav-number">1.1.1.</span> <span class="nav-text">init_module</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init-process"><span class="nav-number">1.1.2.</span> <span class="nav-text">init_process</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exit-process"><span class="nav-number">1.1.3.</span> <span class="nav-text">exit_process</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exit-master"><span class="nav-number">1.1.4.</span> <span class="nav-text">exit_master</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#module%E8%87%AA%E8%BA%AB%E9%85%8D%E7%BD%AE%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E8%A7%A3%E6%9E%90module%E6%8C%87%E4%BB%A4command"><span class="nav-number">2.</span> <span class="nav-text">module自身配置的创建与解析module指令command</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-conf-vs-srv-conf-vs-loc-conf"><span class="nav-number">2.1.</span> <span class="nav-text">main_conf vs srv_conf vs loc_conf</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEmerge"><span class="nav-number">3.</span> <span class="nav-text">配置merge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#merge-loc-conf"><span class="nav-number">3.1.</span> <span class="nav-text">merge_loc_conf</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">Http 请求处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase"><span class="nav-number">4.1.</span> <span class="nav-text">Phase</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Stream-module-hook-%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="nav-number">5.</span> <span class="nav-text">Stream module hook 调用顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Stream-%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">Stream 请求处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Phase-2"><span class="nav-number">6.1.</span> <span class="nav-text">Phase</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#stream-upstream-module-%E5%88%86%E6%9E%90%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%80%BB%E8%BE%91"><span class="nav-number">7.</span> <span class="nav-text">stream upstream module 分析与负载均衡逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E5%88%86nginx-struct%E5%89%96%E6%9E%90"><span class="nav-number">8.</span> <span class="nav-text">部分nginx struct剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-command-t"><span class="nav-number">8.1.</span> <span class="nav-text">ngx_command_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-conf-t"><span class="nav-number">8.2.</span> <span class="nav-text">ngx_conf_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-str-t"><span class="nav-number">8.3.</span> <span class="nav-text">ngx_str_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E5%88%B0Phase%EF%BC%8C%E5%8F%82%E4%B8%8E%E8%AF%B7%E6%B1%82%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">9.</span> <span class="nav-text">Module如何注册到Phase，参与请求的处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4directive"><span class="nav-number">10.</span> <span class="nav-text">指令directive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#master%E5%8F%91%E9%80%81signal"><span class="nav-number">11.</span> <span class="nav-text">master发送signal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#worker-process-%E6%8E%A5%E5%8F%97-master-process-signal"><span class="nav-number">12.</span> <span class="nav-text">worker process 接受 master process signal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#worker-listen-socket-%E8%A7%A3%E5%86%B3listen%E5%86%B2%E7%AA%81"><span class="nav-number">13.</span> <span class="nav-text">worker listen socket 解决listen冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%B1%A0"><span class="nav-number">14.</span> <span class="nav-text">内存池</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http%E8%AF%B7%E6%B1%82%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">15.</span> <span class="nav-text">http请求运行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-connections"><span class="nav-number">15.1.</span> <span class="nav-text">worker_connections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">15.2.</span> <span class="nav-text">健康检查</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="超超哥哥"
      src="/favicon.ico">
  <p class="site-author-name" itemprop="name">超超哥哥</p>
  <div class="site-description" itemprop="description">好奇心</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/taikulawo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;taikulawo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">超超哥哥</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
